function LoadingHandler(e){this.id=e,this.reset()}function verticalSlider(e){e=e||{};var n=$(">div").addClass("thumb"),t=$(">div").addClass("track"),o=$(">div").addClass("vertical-slider");function i(e){n.css({bottom:(100*e).toFixed(1)+"%"})}var r=.5;i(r);var s=function(e){var n=t.e.getBoundingClientRect();r=1-(e.clientY-n.top)/n.height;Math.abs(r-.5)<.05?r=.5:r<0?r=0:1<r&&(r=1),i(r),o.fire("input")},l=$(document.body);o.on("mousedown",function(e){dragging=!0,s(e),l.on("mousemove",s).one("mouseup",function(e){l.off("mousemove",s),o.fire("change")})}),o.on("contextmenu",function(e){return e.preventDefault(),i(r=.5),o.fire("input"),!1});var a=e.max||1,u=e.mid||.5,c=e.min||0;return o.extend({value:function(){var e=u-(a+c)/2;return-4*e*r*r+(a-c+4*e)*r+c}}),o.append(t,n)}!function(){var l=function(e,n){for(var t in n)e[t]=n[t];return e},s=function(e){if(e instanceof Array)return"enumerable";if(e instanceof Node)return"node";var n=typeof e;if("object"===n&&e){if(!isNaN(e.length)&&0<=e.length)return"enumerable";if(!isNaN(e.nodeType))return"node"}return n},r=function(e,n){var t=s(e);if(null!=e){if("node"===t)return new i(e);if("enumerable"===t)return o.apply(this,e);if("string"===t)return o.apply(this,a(e));if("object"===t){if(e._isAltElement)return e;throw new Error("Cannot parse object. "+JSON.stringify(e))}throw new Error("Cannot parse type: %s",t)}},a=function(n){var e=s(n);if("enumerable"===e){for(var t=[],o=0,i=n.length;o<i;o++)Array.prototype.push.apply(t,a(n[o]));return t}if("object"===e){if("_toNode"in n)return[n._toNode()];if("_toAlt"in n)return[n._toAlt()._toNode()];if(n instanceof Node)return[n];console.warn("Cannot make node: unknown object "+JSON.stringify(n))}else{if("string"!==e)return console.error("Cannot turn to nodes, unknown type: "+e),[];if(">"===n[0])return[document.createElement(n.slice(1))];try{t=[];return Array.prototype.push.apply(t,document.querySelectorAll(n)),t}catch(e){console.error("Selector '%s' throws an error",n),console.log(e)}}},o=function(e){s(e);if(1==arguments.length)return r(e)||new u;for(var n=new u,t=0,o=arguments.length;t<o;t++){var i=r(arguments[t]);i&&u.addElement(n,i)}return n};l(o,{extend:l,load:function(e){window.addEventListener("load",e)},supports:{},get:r,toNodes:a});var n={},e=document;function i(e){this.e=e,this._event={}}function u(){this.length=0}o.supports.fullscreen=!0,e.documentElement.requestFullscreen?(console.log("Fullscreen support: Native"),n.requestFullscreen=e.documentElement.requestFullscreen,n.exitFullscreen=e.exitFullscreen,Object.defineProperty(n,"fullscreenElement",{get:function(){return document.fullscreenElement}})):e.documentElement.webkitRequestFullscreen?(console.log("Fullscreen support: webkit"),n.requestFullscreen=e.documentElement.webkitRequestFullscreen,n.exitFullscreen=e.webkitExitFullscreen,Object.defineProperty(n,"fullscreenElement",{get:function(){return document.webkitFullscreenElement}})):e.documentElement.mozRequestFullScreen?(console.log("Fullscreen support: mozilla"),n.requestFullscreen=e.documentElement.mozRequestFullScreen,n.exitFullscreen=e.mozCancelFullScreen,Object.defineProperty(n,"fullscreenElement",{get:function(){return document.mozFullScreenElement}})):e.documentElement.msRequestFullscreen?(console.log("Fullscreen support: msie"),n.requestFullscreen=e.documentElement.msRequestFullscreen,n.exitFullscreen=e.msExitFullscreen,Object.defineProperty(n,"fullscreenElement",{get:function(){return document.msFullscreenElement}})):(console.warn("Fullscreen support: NOT SUPPORTED"),o.supports.fullscreen=!1),i.prototype={_isAltElement:!0,_toNode:function(){return this.e},$:function(){return this.get.apply(this,arguments)},append:function(){for(var e=0,n=arguments.length;e<n;e++)for(var t=a(arguments[e]),o=0,i=t.length;o<i;o++)this.e.appendChild(t[o]);return this},clear:function(){for(var e=this.e;e.firstChild;)e.removeChild(e.firstChild);return this},click:function(){return this.trigger("click")},checked:function(e){return this.prop("checked",e)},children:function(){return o(this.e.children)},css:function(e,n){var t=!1;if(n){for(var o=window.getComputedStyle(this.e).transitionProperty.split(/,\s+/),i=0,r=o.length;i<r;i++)if(o[i]in e){t=!0;break}if(t){var s=this;this.one("webkitTransitionEnd",function(){n.call(s)})}}return l(this.e.style,e),n&&!t&&n.call(this),this},extend:function(e){return l(this,e),this},data:function(e){for(var n in e)this.e.setAttribute("data-"+n.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),e[n]);return this},focus:function(){return this.trigger("focus")},isFullscreen:function(){return n.fullscreenElement==this.e},fullscreen:function(e){return null==e&&(e=!this.isFullscreen()),e?n.requestFullscreen.call(this.e):n.exitFullscreen.call(document),this},get:function(n){try{return o(this.e.querySelectorAll(n))}catch(e){console.error("Selector '%s' throws an error",n),console.log(e)}},html:function(e){return this.prop("innerHTML",e)},on:function(e,n){if("enumerable"==s(e)){for(var t=0,o=e.length;t<o;t++)this.on(e[t],n);return this}var i=this;e in this._event||(this._event[e]=[]);var r=function(e){n.call(i,e)};return this.e.addEventListener(e,r),this._event[e].push({name:e,callback:n,wrapper:r}),this},off:function(e,n){if("enumerable"==s(e)){for(var t=0,o=e.length;t<o;t++)this.off(e[t],n);return this}var i=this._event[e]||[];if(n){var r=!1;for(t=0;t<i.length;t++)e!=i[t].name||n!=i[t].callback||(this.e.removeEventListener(i[t].name,i[t].wrapper),r=!0,i.splice(t,1),t--);r||this.e.removeEventListener(e,n)}else{for(t=0,o=i.length;t<o;t++)this.e.removeEventListener(i[t].name,i[t].wrapper);this._event[e]=[]}return this},one:function(t,o){if("enumerable"==s(t)){for(var e=0,n=t.length;e<n;e++)this.one(t[e],o);return this}return this.on(t,function e(n){this.off(t,e),o.call(this,n)}),this},fire:function(e,n){if("enumerable"==s(e)){for(var t=0,o=e.length;t<o;t++)this.fire(e[t],n);return this}if(n||(n={}),e in this._event){var i=this._event[e];for(t=0,o=i.length;t<o;t++)i[t].wrapper(n)}else{var r;if(document.createEvent)(r=document.createEvent("HTMLEvents")).initEvent(e,!0,!0);else(r=document.createEventObject()).eventType=e;r.eventName=e,document.createEvent?this.e.dispatchEvent(r):this.e.fireEvent("on"+r.eventType,r)}},prop:function(e,n){if("object"==typeof e&&null==n){for(var t in e)this.prop(t,e[t]);return this}var o=typeof n;return"string"!==o&&"boolean"!==o&&"number"!==o?this.e[e]:(this.e[e]=n,this)},play:function(){return this.trigger("play")},pause:function(){return this.trigger("pause")},load:function(){return this.trigger("load")},remove:function(){return this.e.parentNode.removeChild(this.e),this},text:function(e){return this.prop("textContent",e)},set:function(e){for(var n in e)"boolean"===s(e[n])?e[n]?this.e.setAttribute(n,""):this.e.removeAttribute(n):this.e.setAttribute(n,e[n]);return this},class:function(e){return e?(e=e.split(/\s+/),this.addClass.apply(this,e)):this},toggleClass:function(e){if(1==arguments.length)this.e.classList.toggle(e);else for(var n=0,t=arguments.length;n<t;n++)this.toggleClass(arguments[n]);return this},addClass:function(e){if(1==arguments.length)this.e.classList.add(e);else for(var n=0,t=arguments.length;n<t;n++)this.addClass(arguments[n]);return this},hasClass:function(e){return this.e.classList.contains(e)},removeClass:function(e){if(1==arguments.length)this.e.classList.remove(e);else for(var n=0,t=arguments.length;n<t;n++)this.removeClass(arguments[n]);return this},select:function(){return this.trigger("select")},trigger:function(e){return e in this.e?"function"!=typeof this.e[e]?console.error("Can't trigger '"+e+"', not a function"):this.e[e]():console.error("Can't trigger '"+e+"', not found in element"),this},value:function(e){return this.prop("value",e)},with:function(e){return function e(n,t){for(var o in t){if(o in n){if("object"!=typeof n[o])return n[o]==t[o];if(e(n[o],t[o]))continue}return!1}return!0}(this.e,e)?this:new u}},u.prototype={_isAltElement:!0,_isAltGroup:!0,_toNode:function(){for(var e=document.createDocumentFragment(),n=0,t=this.length;n<t;n++)e.appendChild(this[n]._toNode());return e},each:function(e){for(var n=0,t=this.length;n<t;n++)e.call(this[n],n);return this},with:function(e){var n=new u;return this.each(function(){u.addElements(n,[this.with(e)])}),n}},l(u,{addElement:function(e,n){e[e.length++]=n},addElements:function(e,n){for(var t=0,o=n.length;t<o;t++)e[e.length++]=n[t]},addGroup:function(e,n){n.each(function(){e[e.length++]=this})}});var t=i.prototype;for(var c in t)c in u.prototype||(u.prototype[c]=function(n){return function(){var e=arguments;return this.each(function(){this[n].apply(this,e)})}}(c));"$"in window?o in window||(window.alt=o):window.$=o}(),LoadingHandler.maxSimultaneousDownloads=2,LoadingHandler.prototype={start:function(e){this.finished&&console.warn("Race finished, but someone started!"),this.pending++,console.log("STARTED: "+this.id+"["+e+"] ("+this.pending+")"),this.update(e,0)},queue:function(e){this.queuelist.push(e),this.pending<LoadingHandler.maxSimultaneousDownloads&&this.queuelist.length&&this.queuelist.shift()()},update:function(e,n){this.progress[e]=n,this.fire("update",{progress:this.getProgress()})},end:function(e){this.finished&&console.warn("Race finished, but someone ended! ("+e+")"),this.pending--,this.update(e,1),console.log("ENDED: "+this.id+"["+e+"] ("+this.pending+")"),this.pending<LoadingHandler.maxSimultaneousDownloads&&this.queuelist.length?this.queuelist.shift()():0==this.pending&&this.finish()},reset:function(){this.progress={},this.pending=0,this.error=!1,this.finished=!1,this.queuelist=[],this.callbacks={finish:[],update:[]}},getProgress:function(){var e=0,n=this.queuelist.length;for(var t in this.progress)n++,e+=this.progress[t];return 0==n?0:e/n},finish:function(){this.finished=!0,console.log("FINISHED: "+this.id+" ("+this.pending+")"),this.fire("update",{progress:1}),this.fire("finish")},fire:function(e,n){if(n=n||{},!this.error)for(var t=this.callbacks[e],o=0,i=t.length;o<i;o++)t[o](n)},on:function(e,n){this.callbacks[e].push(n)}};var player=function(){var i=null;console.log("Hello, this is a debug version of the player");var o,n,r=new LoadingHandler("PRELOAD"),s=new LoadingHandler("PREPARING"),l=new LoadingHandler("LOADING"),a={};function u(e,n){this.id=e,this.src=n,this.element=$(">video").addClass("full").set({preload:"auto",playsinline:"",muted:""})}u.prototype={_toAlt:function(){return this.element},show:function(){this.element.css({zIndex:1,opacity:1})},hide:function(){this.element.css({zIndex:0,opacity:0}).prop({currentTime:0})},stop:function(){this.element.pause().css({zIndex:0})},preplay:function(){var n=this;function t(){n.element.pause().prop({currentTime:0}).off("timeupdate").off("ended"),l.end("pre-"+n.id)}l.start("pre-"+this.id),this.element.prop({playbackRate:3}).on("timeupdate",function(){var e=this.e.currentTime;5<=e||e>=this.e.duration?t():l.update("pre-"+n.id,e/5)}).one("ended",function(){t()}).play()},ready:function(){this.element.prop({playbackRate:1,currentTime:0}).on("ended",function(){S()})},prepare:function(){var e=this;s.queue(function(){s.start("prepare-"+e.id),e.element.on("error",function(e){A(e.message)}).one("canplaythrough",function(){console.log("VIDEO PREPARED: ->"+e.src),s.end("prepare-"+e.id)}).set({src:e.src}).load()})}};var t,c,d={nw:1,n:1,ne:1,w:1,c:1,e:1,sw:1,s:1,se:1},f={"control-replay":function(){return $(">button").addClass("icon-text","large","scene").set({name:"replay"}).text("Replay?").on("click",function(){H.changeScene(c.id)})},"control-pause":function(){return $(">button").addClass("control-pause").append($(">span").class("icon").set({name:"pause"})).on("click",function(e){e.stopPropagation(),function(){if(!o)return;var e=o.element.prop("paused");e?o.element.play():o.element.pause();i.$(".control-pause .icon").set({name:e?"pause":"play"})}()})},"control-speed":function(e){var n=verticalSlider({min:e.min||.5,mid:e.mid||1,max:e.max||3}).on("change",function(){E(this.value(),!0)}).on("input",function(){E(this.value())}),t=$(">div").addClass("popup","hidden","fade").append(n),o=$(">button").addClass("control-speed").append($(">span").class("icon").set({name:"speed"})).on("click",function(e){e.stopPropagation(),t.hasClass("hidden")&&(t.removeClass("hidden"),$(document.body).one("click",function(){t.addClass("hidden")}))});return $(">div").addClass("button-popup").append(t,o)},"control-hide":function(){return $(">button").addClass("control-hide").append($(">span").class("icon").set({name:"hide"})).on("click",function(e){e.stopPropagation(),F()})},"control-fullscreen":function(){return $(">button").addClass("control-fullscreen").append($(">span").class("icon").set({name:"fullscreen"})).on("click",function(e){e.stopPropagation(),k()})},button:function(n){(n=n||{}).delay||(n.delay=150);var e=$(">button").addClass("scene").css({opacity:0}).prop({disabled:!0}),t=n.text||"";return e.text(t),n.class&&e.class(n.class),n.scene?e.on("click",function(e){e.stopPropagation(),H.changeScene(n.scene)}):console.warn("Button without scene!"),setTimeout(function(){e.css({opacity:1}).prop({disabled:!1})},n.delay),e}},h={},p={},g=[];function m(e,n,t){t=t||{},this.id=e,this.type=n,this.videos=t.videos||[],t.ratio?t.ratio.length!==t.videos.length&&(console.warn("Ratio lengths do not match in scene "+e),t.ratio=null):t.ratio=null,this.ratio=t.ratio,this.next=t.next,this.controls=t.controls||[]}function v(e,n){e=_(e);q(c=e,!0);var t=e.pop();t&&function(e,n){console.log("Loading fake video...");var t=!1;function o(){t?console.warn("Video load was fired multiple times!"):(t=!0,this.off("canplaythrough").off("canplay").removeClass("hidden"),console.log("Fake video loaded!"),n())}3<i.$(".background > video.fake").one("canplaythrough",o).one("canplay",o).one("load",o).on("error",function(){A("Video playback error")}).set({src:e}).e.readyState&&(console.log("Immediate fire"),o())}(p[t],n)}function y(){i.$(".loading > .full").addClass("hidden")}function b(e){y(),$(".loading-text").removeClass("hidden").$("h2").text(e)}function w(e){e=(100*e).toFixed(2),i.$(".loading-bar").css({width:e+"%"})}function C(){i.$(".post").addClass("hidden")}function E(e,n){if(n)for(var t in console.log("Speed change: "+e),a)a[t].element.prop({playbackRate:e});else{if(!o)return;o.element.prop({playbackRate:e})}}function k(){var e=i;e.fullscreen(),i.$(".control-fullscreen .icon").set({name:e.isFullscreen()?"fullscreen":"exit-fullscreen"})}function F(e){var n=i.$(".controls");null==e?n.toggleClass("hidden"):e?n.removeClass("hidden"):n.addClass("hidden"),i.$(".control-hide .icon").set({name:n.hasClass("hidden")?"show":"hide"})}function x(e){for(var n=0,t=e.length;n<t;n++){var o=e[n],i=o.type,r=o.location;r in d||(r="s"),i in f&&d[r].append(f[i](o))}}function e(e){if(null==e)return S();if(e in h)console.log("Playing scene "+e),q(h[e]);else{if(!(e in a))throw new Error('Cannot play "'+e+'": not found');console.log("Playing video "+e),P(a[e])}}function S(){g.length?(console.log("Playing next in playlist"),e(g.shift())):t&&"loop"===t.type&&(console.log("Looping loop scene"),e(t.pop()))}function P(e){o&&(null!=e&&o.id==e.id||(o.stop(),null!=n&&o.id==n.id||(n&&n.hide(),n=o))),(o=e)&&(o.show(),o.element.play())}function L(){Array.prototype.push.apply(g,arguments)}function q(e,n){t&&console.warn("Change scene from %s to %s",t.id,e.id),g=[],0<(t=e).videos.length?L(t.pop()):P(),e.next&&(console.log("Next scene found, queueing that after..."),L(e.next)),i.$(".controls .scene").remove(),x(t.controls),n||S()}function N(){y(),i.$(".videos").clear(),i.$(".controls .tbt .tbt").clear(),C(),i.$(".background > video.fake").addClass("blurred"),i.$(".background > .bg-thumb").addClass("hidden")}function A(e){console.error("Playback error: "+e),r.error=s.error=l.error=!0,C(),y(),b("Playback Error :<")}function R(e,n){if(e in a)return console.log("Video "+e+" already loaded.");var t,o=new u(e,n);return(a[e]=o).prepare(),t=o,i.$(".videos").append(t),o}function _(e){var n=e.id;return n in h?(console.log("Scene "+n+" already loaded."),h[n]):h[n]=e}function T(e){if(r.on("finish",function(){console.log("Preload done"),i.$(".background > .bg-thumb").removeClass("hidden"),function(o){for(var e in b("Preparing..."),s.on("finish",function(){function n(){y(),setTimeout(function(){var e,n;e=function(){setTimeout(function(){D(o)},500)},(n=i.$(".loading-button")).removeClass("hidden"),n.$("button").off("click").one("click",function(){y()}).one("click",e)},500)}for(var t in console.log("Loading done"),a){t=a[t].element;break}if(t){var e=t.e.play();e?e.then(function(){console.warn("Fast play successful"),t.pause(),D(o)},function(e){console.warn(e+" but its okay. Continuing the longer route."),t.pause(),n()}):(t.pause(),n())}else n()}),s.on("update",function(e){w(e.progress)}),s.start("wait1s"),setTimeout(function(){s.end("wait1s")},250),x(o.options||[]),p)R(e,p[e]);if("scene"in o)for(var n in o.scene){var t=o.scene[n];_(m.create(n,t.type,t))}}(e)}),"ids"in e)for(var n in e.ids)p[n]=e.ids[n];var t,o;if(e.bg&&(r.start("bg"),t=e.bg,o=function(){r.end("bg")},i.$(".bg-thumb").on("error",function(e){A("Background image error")}).one("load",o).set({src:t})),"start"in e){if(!(e.start in e.scene))return A("Start scene "+e.start+" not found");r.start("startscene"),v(m.create(e.start,e.scene[e.start].type,e.scene[e.start]),function(){r.end("startscene")})}else A("No start scene!")}function D(e){for(var n in b("Loading..."),l.on("finish",function(){for(var e in a)a[e].ready();setTimeout(function(){y(),g[0]in a&&a[g[0]].show(),i.$(".post").removeClass("hidden"),setTimeout(function(){S(),i.$(".post").removeClass("blurred")},300)},250)}),l.on("update",function(e){w(e.progress)}),a)a[n].preplay()}function j(e){e=e||{},N(),c=t=n=o=null,g=[],a={},h={},p={},r.reset(),s.reset(),l.reset(),T(e)}m.prototype={pop:function(){var e=this.videos,n=e.length;if(1==n)return e[0];var t=Math.random();if(this.ratio){for(var o=this.ratio,i=n,r=0;i--;)r+=o[i];var s=t*r,l=0;for(r=0;r<s;)r+=o[l++];return e[l-1]}return e[Math.floor(t*n)]}},m.create=function(e,n,t){return new m(e,n||"straight",t)};var H={load:function(e){j(e)},attach:function(e){!function(e){for(var n in i=$(e),d)d[n]=i.$(".controls-"+n);i.$(".controls").on("click",function(){F(!0)}),i.$(".videos").on("dblclick",function(){k()}),i.$(".controls button,input").on("click",function(e){e.stopPropagation()})}(e)},changeScene:function(e){t&&e==t.id?console.log("changeScene: Scene ID is the same as current scene."):e in h?(i.$("button.scene").css({opacity:0}).prop({disabled:!0}),g=[],L(e),o||S()):console.error("changeScene: Scene ID not found!")}};return H}();
