function LoadingHandler(e){this.id=e,this.reset()}function Video(e){this.src=e,this.element=$(">video").addClass("full").set({preload:"auto",playsinline:"",muted:""})}function Scene(e,n,t){if(this.id=e,this.type=n,t.play?t.play instanceof Array||(t.play=[t.play]):t.play=[],this.videos=t.play,t.ratio){if(t.ratio.length!==t.videos.length)return error("Ratio lengths do not match in scene "+e)}else t.ratio=null;this.ratio=t.ratio,this.next=t.next,this.controls=t.controls||[]}function verticalSlider(e){e=e||{};var n=$(">div").addClass("thumb"),t=$(">div").addClass("track"),o=$(">div").addClass("vertical-slider");function r(e){n.css({bottom:(100*e).toFixed(1)+"%"})}var i=.5;r(i);var s=function(e){var n=t.e.getBoundingClientRect();i=1-(e.clientY-n.top)/n.height;Math.abs(i-.5)<.05?i=.5:i<0?i=0:1<i&&(i=1),r(i),o.fire("input")},l=$(document.body);o.on("mousedown",function(e){dragging=!0,s(e),l.on("mousemove",s).one("mouseup",function(e){l.off("mousemove",s),o.fire("change")})}),o.on("contextmenu",function(e){return e.preventDefault(),r(i=.5),o.fire("input"),!1});var a=e.max||1,c=e.mid||.5,u=e.min||0;return o.extend({value:function(){var e=c-(a+u)/2;return-4*e*i*i+(a-u+4*e)*i+u}}),o.append(t,n)}!function(){var l=function(e,n){for(var t in n)e[t]=n[t];return e},s=function(e){if(e instanceof Array)return"enumerable";if(e instanceof Node)return"node";var n=typeof e;if("object"===n&&e){if(!isNaN(e.length)&&0<=e.length)return"enumerable";if(!isNaN(e.nodeType))return"node"}return n},i=function(e,n){var t=s(e);if(null!=e){if("node"===t)return new r(e);if("enumerable"===t)return o.apply(this,e);if("string"===t)return o.apply(this,a(e));if("object"===t){if(e._isAltElement)return e;throw new Error("Cannot parse object. "+JSON.stringify(e))}throw new Error("Cannot parse type: %s",t)}},a=function(n){var e=s(n);if("enumerable"===e){for(var t=[],o=0,r=n.length;o<r;o++)Array.prototype.push.apply(t,a(n[o]));return t}if("object"===e){if("_toNode"in n)return[n._toNode()];if("_toAlt"in n)return[n._toAlt()._toNode()];if(n instanceof Node)return[n];console.warn("Cannot make node: unknown object "+JSON.stringify(n))}else{if("string"!==e)return console.error("Cannot turn to nodes, unknown type: "+e),[];if(">"===n[0])return[document.createElement(n.slice(1))];try{t=[];return Array.prototype.push.apply(t,document.querySelectorAll(n)),t}catch(e){console.error("Selector '%s' throws an error",n),console.log(e)}}},o=function(e){s(e);if(1==arguments.length)return i(e)||new c;for(var n=new c,t=0,o=arguments.length;t<o;t++){var r=i(arguments[t]);r&&c.addElement(n,r)}return n};l(o,{extend:l,load:function(e){window.addEventListener("load",e)},supports:{},get:i,toNodes:a});var n={},e=document;function r(e){this.e=e,this._event={}}function c(){this.length=0}o.supports.fullscreen=!0,e.documentElement.requestFullscreen?(console.log("Fullscreen support: Native"),n.requestFullscreen=e.documentElement.requestFullscreen,n.exitFullscreen=e.exitFullscreen,Object.defineProperty(n,"fullscreenElement",{get:function(){return document.fullscreenElement}})):e.documentElement.webkitRequestFullscreen?(console.log("Fullscreen support: webkit"),n.requestFullscreen=e.documentElement.webkitRequestFullscreen,n.exitFullscreen=e.webkitExitFullscreen,Object.defineProperty(n,"fullscreenElement",{get:function(){return document.webkitFullscreenElement}})):e.documentElement.mozRequestFullScreen?(console.log("Fullscreen support: mozilla"),n.requestFullscreen=e.documentElement.mozRequestFullScreen,n.exitFullscreen=e.mozCancelFullScreen,Object.defineProperty(n,"fullscreenElement",{get:function(){return document.mozFullScreenElement}})):e.documentElement.msRequestFullscreen?(console.log("Fullscreen support: msie"),n.requestFullscreen=e.documentElement.msRequestFullscreen,n.exitFullscreen=e.msExitFullscreen,Object.defineProperty(n,"fullscreenElement",{get:function(){return document.msFullscreenElement}})):(console.warn("Fullscreen support: NOT SUPPORTED"),o.supports.fullscreen=!1),r.prototype={_isAltElement:!0,_toNode:function(){return this.e},$:function(){return this.get.apply(this,arguments)},append:function(){for(var e=0,n=arguments.length;e<n;e++)for(var t=a(arguments[e]),o=0,r=t.length;o<r;o++)this.e.appendChild(t[o]);return this},clear:function(){for(var e=this.e;e.firstChild;)e.removeChild(e.firstChild);return this},click:function(){return this.trigger("click")},checked:function(e){return this.prop("checked",e)},children:function(){return o(this.e.children)},css:function(e,n){var t=!1;if(n){for(var o=window.getComputedStyle(this.e).transitionProperty.split(/,\s+/),r=0,i=o.length;r<i;r++)if(o[r]in e){t=!0;break}if(t){var s=this;this.one("webkitTransitionEnd",function(){n.call(s)})}}return l(this.e.style,e),n&&!t&&n.call(this),this},extend:function(e){return l(this,e),this},data:function(e){for(var n in e)this.e.setAttribute("data-"+n.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),e[n]);return this},focus:function(){return this.trigger("focus")},isFullscreen:function(){return n.fullscreenElement==this.e},fullscreen:function(e){return null==e&&(e=!this.isFullscreen()),e?n.requestFullscreen.call(this.e):n.exitFullscreen.call(document),this},get:function(n){try{return o(this.e.querySelectorAll(n))}catch(e){console.error("Selector '%s' throws an error",n),console.log(e)}},html:function(e){return this.prop("innerHTML",e)},on:function(e,n){if("enumerable"==s(e)){for(var t=0,o=e.length;t<o;t++)this.on(e[t],n);return this}var r=this;e in this._event||(this._event[e]=[]);var i=function(e){n.call(r,e)};return this.e.addEventListener(e,i),this._event[e].push({name:e,callback:n,wrapper:i}),this},off:function(e,n){if("enumerable"==s(e)){for(var t=0,o=e.length;t<o;t++)this.off(e[t],n);return this}var r=this._event[e]||[];if(n){var i=!1;for(t=0;t<r.length;t++)e!=r[t].name||n!=r[t].callback||(this.e.removeEventListener(r[t].name,r[t].wrapper),i=!0,r.splice(t,1),t--);i||this.e.removeEventListener(e,n)}else{for(t=0,o=r.length;t<o;t++)this.e.removeEventListener(r[t].name,r[t].wrapper);this._event[e]=[]}return this},one:function(t,o){if("enumerable"==s(t)){for(var e=0,n=t.length;e<n;e++)this.one(t[e],o);return this}return this.on(t,function e(n){this.off(t,e),o.call(this,n)}),this},fire:function(e,n){if("enumerable"==s(e)){for(var t=0,o=e.length;t<o;t++)this.fire(e[t],n);return this}if(n||(n={}),e in this._event){var r=this._event[e];for(t=0,o=r.length;t<o;t++)r[t].wrapper(n)}else{var i;if(document.createEvent)(i=document.createEvent("HTMLEvents")).initEvent(e,!0,!0);else(i=document.createEventObject()).eventType=e;i.eventName=e,document.createEvent?this.e.dispatchEvent(i):this.e.fireEvent("on"+i.eventType,i)}},prop:function(e,n){if("object"==typeof e&&null==n){for(var t in e)this.prop(t,e[t]);return this}var o=typeof n;return"string"!==o&&"boolean"!==o&&"number"!==o?this.e[e]:(this.e[e]=n,this)},play:function(){return this.trigger("play")},pause:function(){return this.trigger("pause")},load:function(){return this.trigger("load")},remove:function(){return this.e.parentNode.removeChild(this.e),this},text:function(e){return this.prop("textContent",e)},set:function(e){for(var n in e)"boolean"===s(e[n])?e[n]?this.e.setAttribute(n,""):this.e.removeAttribute(n):this.e.setAttribute(n,e[n]);return this},class:function(e){return e?(e=e.split(/\s+/),this.addClass.apply(this,e)):this},toggleClass:function(e){if(1==arguments.length)this.e.classList.toggle(e);else for(var n=0,t=arguments.length;n<t;n++)this.toggleClass(arguments[n]);return this},addClass:function(e){if(1==arguments.length)this.e.classList.add(e);else for(var n=0,t=arguments.length;n<t;n++)this.addClass(arguments[n]);return this},hasClass:function(e){return this.e.classList.contains(e)},removeClass:function(e){if(1==arguments.length)this.e.classList.remove(e);else for(var n=0,t=arguments.length;n<t;n++)this.removeClass(arguments[n]);return this},select:function(){return this.trigger("select")},trigger:function(e){return e in this.e?"function"!=typeof this.e[e]?console.error("Can't trigger '"+e+"', not a function"):this.e[e]():console.error("Can't trigger '"+e+"', not found in element"),this},value:function(e){return this.prop("value",e)},with:function(e){return function e(n,t){for(var o in t){if(o in n){if("object"!=typeof n[o])return n[o]==t[o];if(e(n[o],t[o]))continue}return!1}return!0}(this.e,e)?this:new c}},c.prototype={_isAltElement:!0,_isAltGroup:!0,_toNode:function(){for(var e=document.createDocumentFragment(),n=0,t=this.length;n<t;n++)e.appendChild(this[n]._toNode());return e},each:function(e){for(var n=0,t=this.length;n<t;n++)e.call(this[n],n);return this},with:function(e){var n=new c;return this.each(function(){c.addElements(n,[this.with(e)])}),n}},l(c,{addElement:function(e,n){e[e.length++]=n},addElements:function(e,n){for(var t=0,o=n.length;t<o;t++)e[e.length++]=n[t]},addGroup:function(e,n){n.each(function(){e[e.length++]=this})}});var t=r.prototype;for(var u in t)u in c.prototype||(c.prototype[u]=function(n){return function(){var e=arguments;return this.each(function(){this[n].apply(this,e)})}}(u));"$"in window?o in window||(window.alt=o):window.$=o}(),LoadingHandler.maxSimultaneousDownloads=2,LoadingHandler.prototype={start:function(e){this.finished&&console.warn("Race finished, but someone started!"),this.pending++,console.log("STARTED: "+this.id+"["+e+"] ("+this.pending+")"),this.update(e,0)},queue:function(e){this.queuelist.push(e),this.pending<LoadingHandler.maxSimultaneousDownloads&&this.queuelist.length&&this.queuelist.shift()()},update:function(e,n){this.progress[e]=n,this.fire("update",{progress:this.getProgress()})},end:function(e){this.finished&&console.warn("Race finished, but someone ended! ("+e+")"),this.pending--,this.update(e,1),console.log("ENDED: "+this.id+"["+e+"] ("+this.pending+")"),this.pending<LoadingHandler.maxSimultaneousDownloads&&this.queuelist.length?this.queuelist.shift()():0==this.pending&&this.finish()},reset:function(){this.progress={},this.pending=0,this.error=!1,this.finished=!1,this.queuelist=[],this.callbacks={finish:[],update:[]}},getProgress:function(){var e=0,n=this.queuelist.length;for(var t in this.progress)n++,e+=this.progress[t];return 0==n?0:e/n},finish:function(){this.finished=!0,console.log("FINISHED: "+this.id+" ("+this.pending+")"),this.fire("update",{progress:1}),this.fire("finish")},fire:function(e,n){if(n=n||{},!this.error)for(var t=this.callbacks[e],o=0,r=t.length;o<r;o++)t[o](n)},on:function(e,n){this.callbacks[e].push(n)}},Video.prototype={_toAlt:function(){return this.element},preplay:function(e,n){var t=this,o=!1;function r(){o||(o=!0,t.element.pause().prop({currentTime:0}).off("timeupdate").off("ended"),e())}this.element.prop({playbackRate:5}).on("timeupdate",function(){var e=this.e.currentTime;5<=e||e>=this.e.duration?r():n(e/5)}).one("ended",function(){r()}).play()},prepare:function(e){var o=this,r=1e3;!function n(){var t=setTimeout(function(){var e=o.element.e.readyState;console.warn(o.src+" is taking a while to load. (readyState="+e+")"),0==e&&n()},r);o.element.on("error",function(e){clearTimeout(t),player&&player.error("Video prepare error "+e.message)}).one("canplaythrough",function(){clearTimeout(t),e&&e()}).set({src:o.src+"?random="+Math.random()}).load()}()}},Scene.prototype={pop:function(){var e=this.videos,n=e.length;if(1==n)return e[0];var t=Math.random();if(this.ratio){for(var o=this.ratio,r=n,i=0;r--;)i+=o[r];var s=t*i,l=0;for(i=0;i<s;)i+=o[l++];return e[l-1]}return e[Math.floor(t*n)]}},Scene.create=function(e,n,t){return new Scene(e,n||"straight",t=t||{})};var player=function(){var c=null;console.log("Hello, this is a debug version of the player");var o,n,u=new LoadingHandler("PRELOAD"),d=new LoadingHandler("PREPARING"),t=new LoadingHandler("LOADING"),f={};function r(e,n){this.id=e,this.video=new Video(n)}function i(e){for(var n in c=$(e),l)l[n]=c.$(".controls-"+n);c.$(".controls").on("click",function(){k(!0)}),c.$(".videos").on("dblclick",function(){E()}),c.$(".controls button,input").on("click",function(e){e.stopPropagation()}),console.log("Player attached to "+c.e)}r.prototype={_toAlt:function(){return this.video._toAlt()},show:function(){this.video.element.css({zIndex:1})},hide:function(){this.video.element.css({zIndex:0}).prop({currentTime:0})},stop:function(){this.video.element.pause().css({zIndex:0})},preplay:function(){var n=this;t.queue(function(){t.start("pre-"+n.id),n.video.preplay(function(){t.end("pre-"+n.id)},function(e){t.update("pre-"+n.id,e)})})},ready:function(){this.video.element.prop({playbackRate:1,currentTime:0}).on("ended",function(){x()})},prepare:function(){var e=this;d.queue(function(){d.start("prepare-"+e.id),e.video.prepare(function(){console.log("VIDEO PREPARED: ->"+e.id),d.end("prepare-"+e.id)})})}};var s,h,l={nw:1,n:1,ne:1,w:1,c:1,e:1,sw:1,s:1,se:1},a={"control-replay":function(){return $(">button").addClass("icon-text","large","scene").set({name:"replay"}).text("Replay?").on("click",function(){j.changeScene(h.id)})},"control-pause":function(){return $(">button").addClass("control-pause").append($(">span").class("icon").set({name:"pause"})).on("click",function(e){e.stopPropagation(),function(){if(!o)return;var e=o.video.element.prop("paused");e?o.video.element.play():o.video.element.pause();c.$(".control-pause .icon").set({name:e?"pause":"play"})}()})},"control-speed":function(e){var n=verticalSlider({min:e.min||.5,mid:e.mid||1,max:e.max||3}).on("change",function(){C(this.value(),!0)}).on("input",function(){C(this.value())}),t=$(">div").addClass("popup","hidden","fade").append(n),o=$(">button").addClass("control-speed").append($(">span").class("icon").set({name:"speed"})).on("click",function(e){e.stopPropagation(),t.hasClass("hidden")&&(t.removeClass("hidden"),$(document.body).one("click",function(){t.addClass("hidden")}))});return $(">div").addClass("button-popup").append(t,o)},"control-hide":function(){return $(">button").addClass("control-hide").append($(">span").class("icon").set({name:"hide"})).on("click",function(e){e.stopPropagation(),k()})},"control-fullscreen":function(){return $(">button").addClass("control-fullscreen").append($(">span").class("icon").set({name:"fullscreen"})).on("click",function(e){e.stopPropagation(),E()})},button:function(n){(n=n||{}).delay||(n.delay=150);var e=$(">button").addClass("scene").css({opacity:0}).prop({disabled:!0}),t=n.text||"";return e.text(t),n.class&&e.class(n.class),n.scene?e.on("click",function(e){e.stopPropagation(),j.changeScene(n.scene)}):console.warn("Button without scene!"),setTimeout(function(){e.css({opacity:1}).prop({disabled:!1})},n.delay),e}},p={},g={},m=[];function v(){c.$(".loading > .full").addClass("hidden")}function y(e){console.log(e),v(),c.$(".loading-text").removeClass("hidden").$("h2").text(e)}function b(e){e=(100*e).toFixed(2),c.$(".loading-bar").css({width:e+"%"})}function w(){c.$(".post,.bg-content").addClass("blurred")}function C(e,n){if(n)for(var t in console.log("Speed change: "+e),f)f[t].video.element.prop({playbackRate:e});else{if(!o)return;o.video.element.prop({playbackRate:e})}}function E(){var e=c;e.fullscreen(),c.$(".control-fullscreen .icon").set({name:e.isFullscreen()?"fullscreen":"exit-fullscreen"})}function k(e){var n=c.$(".controls");null==e?n.toggleClass("hidden"):e?n.removeClass("hidden"):n.addClass("hidden"),c.$(".control-hide .icon").set({name:n.hasClass("hidden")?"show":"hide"})}function F(e){for(var n=0,t=e.length;n<t;n++){var o=e[n],r=o.type,i=o.location;i in l||(i="s"),r in a?l[i].append(a[r](o)):console.warn("Blueprint not found: "+r)}}function e(e){if(null==e)return x();if(e in g)console.log("Playing scene "+e),A(g[e]);else{if(!(e in f))throw new Error('Cannot play "'+e+'": not found');console.log("Playing video "+e),S(f[e])}}function x(){m.length?(console.log("Playing next in playlist"),e(m.shift())):s&&"loop"===s.type&&(console.log("Looping loop scene"),e(s.pop()))}function S(e){o&&(null!=e&&o.id==e.id||(o.stop(),null!=n&&o.id==n.id||(n&&n.hide(),n=o))),(o=e)&&(o.show(),o.video.element.play())}function P(){Array.prototype.push.apply(m,arguments)}function A(e,n){s&&console.warn("Change scene from %s to %s",s.id,e.id),m=[],0<(s=e).videos.length?P(s.pop()):S(),e.next&&(console.log("Next scene found, queueing that after..."),P(e.next)),c.$(".controls .scene").remove(),F(s.controls),n||x()}function L(){v(),c.$(".videos").clear(),c.$(".controls > .row > .col > *").remove(),w(),c.$(".post").addClass("hidden"),c.$(".background video.fake").addClass("blurred"),c.$(".bg-background").addClass("hidden"),c.$(".bg-thumb").addClass("hidden"),c.$(".pre .background").removeClass("hidden")}function N(e){console.error("Playback error: "+e),u.error=d.error=t.error=!0,w(),v(),y("Playback Error :<")}function q(e,n){if(e in f)return console.log("Video "+e+" already loaded.");var t,o=new r(e,n);return(f[e]=o).prepare(),t=o,c.$(".videos").append(t),o}function T(e){var n=e.id;return n in g?(console.log("Scene "+n+" already loaded."),g[n]):g[n]=e}function _(e){if(u.on("finish",function(){console.log("Preload done"),c.$(".bg-background").removeClass("hidden"),c.$(".bg-thumb").removeClass("hidden"),setTimeout(function(){!function(e){for(var n in y("Preparing..."),d.on("finish",function(){console.log("Loading done"),function(n){function t(){v(),setTimeout(function(){var e;e=function(){setTimeout(function(){R(n)},500)},c.$(".loading-button").removeClass("hidden").$("button").off("click").one("click",function(){v()}).one("click",e)},500)}for(var o in f){o=f[o].element;break}if(o){var e=o.e.play();e?e.then(function(){console.warn("Fast play successful"),o.pause(),R(n)},function(e){console.warn(e+" but its okay. Continuing the longer route."),o.pause(),t()}):(o.pause(),t())}else t()}(e)}),d.on("update",function(e){b(e.progress)}),d.start("wait1s"),setTimeout(function(){d.end("wait1s")},250),p)q(n,p[n]);var t=e.struct.scenes;for(var o in t){var r=t[o];T(Scene.create(o,r.type,r))}}(e)},222)}),"source"in e)for(var n in e.source)p[n]=e.source[n];var t,o,r,i,s;if("config"in e&&((t=(t=e.config)||{}).controls?F(t.controls):F([{type:"control-pause",location:"sw"},{type:"control-speed",location:"sw",min:.5,max:3,default:1},{type:"control-hide",location:"se"},{type:"control-fullscreen",location:"se"}]),t.bg&&(u.start("bg"),o=t.bg,r=function(){u.end("bg")},c.$(".bg-background").on("error",function(e){N("Background image error")}).one("load",r).set({src:o})),t.thumb&&(u.start("bg"),i=t.thumb,s=function(){u.end("bg")},c.$(".bg-thumb").on("error",function(e){N("Thumb image error")}).one("load",s).set({src:i})),t.cover&&c.$(".bg-thumb").css({objectFit:"cover"})),"struct"in e){var l=e.struct.start,a=e.struct.scenes;if(!l)return N("No start scene!");if(!a)return N("No scenes provided!");if(!(l in a))return N('Start scene "'+e.start+'" not found in scenes!');u.start("startscene"),function(e,n){var e=T(e);A(h=e,!0);var t=e.pop();t||console.warn('No video in scene "'+e.id+'". Are you sure the scene.play property is populated?');{if(!(t in p))return N('First video load failure; source "'+t+'" not found');!function(e,n){console.log("Loading fake video...");var t=new Video(e),o=t.element.addClass("fade","fake","hidden");c.$(".background .fake-video").append(o),t.prepare(function(){o.removeClass("hidden"),n()})}(p[t],n)}}(Scene.create(l,a[l].type,a[l]),function(){u.end("startscene")})}}function R(e){for(var n in y("Loading..."),t.on("finish",function(){setTimeout(function(){for(var e in f)f[e].ready();v(),m[0]in f&&f[m[0]].show(),c.$(".post").removeClass("hidden"),setTimeout(function(){x(),c.$(".post,.bg-content").removeClass("blurred")},20)},250)}),t.on("update",function(e){b(e.progress)}),e.config.cover&&c.$("video").css({objectFit:"cover"}),f)f[n].preplay()}function D(e){if(!e)return N("Load: arguments were empty.");e.config=e.config||{},e.source=e.source||{},e.struct=e.struct||{},i(e.config.element||$("#player")),L(),h=s=n=o=null,m=[],f={},g={},p={},u.reset(),d.reset(),t.reset(),_(e)}var j={load:function(e){D(e)},attach:function(e){i(e)},error:function(e){N(e)},changeScene:function(e){s&&e==s.id?console.log("changeScene: Scene ID is the same as current scene."):e in g?(c.$("button.scene").css({opacity:0}).prop({disabled:!0}),m=[],P(e),o||x()):console.error("changeScene: Scene ID not found!")}};return j}();
